<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LERM ATIS Report</title>
    <style>
        body {
            font-family: monospace;
            background-color: #000;
            color: #0f0;
            margin: 20px;
        }

        pre {
            background-color: #111;
            padding: 15px;
            border: 1px solid #0f0;
            white-space: pre-wrap;
        }

        h1 {
            color: #00ff00;
        }

        .report-box {
            margin-bottom: 30px;
        }

        .raw-data-container {
            /* Default for small screens (Mobile-First): Stack vertically */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .raw-data-box {
            flex: 1;
            min-width: 0;
        }

        .raw-data-box h3 {
            color: #00ffaa;
            margin-bottom: 5px;
        }

        /* Use a media query to switch to a row layout on wider screens */
        @media (min-width: 768px) {
            .raw-data-container {
                flex-direction: row;
                /* Display side-by-side */
            }
        }
    </style>
</head>

<body>

    <h1>LERM Terminal Information</h1>

    <div class="report-box">
        <h2>D-ATIS Report (Digital)</h2>
        <pre id="datis-report">Loading...</pre>
    </div>

    <div class="report-box">
        <h2>Spoken Voice Report (Full)</h2>
        <pre id="full-report">Loading...</pre>
    </div>

    <div class="report-box">
        <h2>Raw Data Sources</h2>
        <div class="raw-data-container">
            <div class="raw-data-box">
                <h3>AEMET Data Source</h3>
                <pre id="raw-aemet">Loading...</pre>
            </div>
            <div class="raw-data-box">
                <h3>LERM Data Source</h3>
                <pre id="raw-lerm">Loading...</pre>
            </div>
            <div class="raw-data-box">
                <h3>Windy Data Source</h3>
                <pre id="raw-windy">Loading...</pre>
            </div>
        </div>
    </div>

    <script>
        // --- TEXT-TO-SPEECH FUNCTION (Remains the same) ---
        /**
         * Converts a string of text into speech using the browser's native Web Speech API.
         */
        function speakText(text, lang = 'en-US', rate = 1.0) {
            if ('speechSynthesis' in window && text) {
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = rate;

                window.speechSynthesis.onvoiceschanged = () => {
                    const voices = window.speechSynthesis.getVoices();
                    const targetVoice = voices.find(voice => voice.lang === lang || voice.lang.startsWith(lang.substring(0, 2)));
                    if (targetVoice) {
                        utterance.voice = targetVoice;
                    }
                };

                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("Web Speech API not supported or no text provided.");
            }
        }

        // --- NEW: FORMATTING FUNCTION FOR ATIS READ-BACK ---
        /**
         * Applies aviation read-back conventions to the spoken text.
         */
        function formatSpokenText(text) {
            if (!text) return "";

            // 1. Remove ':' from time (e.g., 18:50Z becomes 18 50Z)
            let formattedText = text.replace(/(\d{1,2}):(\d{2}Z)/g, '$1 $2');

            // 2. Replace '.' from frequencies/decimals with the word "decimal"
            // This targets most numeric decimals not already handled by a specific rule.
            formattedText = formattedText.replace(/(\d)\.(\d)/g, '$1 decimal $2');

            // 3. Separate digits so they are read one by one (e.g., QNH 1021 becomes QNH one zero two one)
            // This targets sequences of 3 or more digits (like QNH, or large visibility).
            formattedText = formattedText.replace(/(\b\d{3,}\b)/g, (match) => {
                return match.split('').join(' ');
            });

            // 4. Ensure QNH is pronounced "Kyu En Eych" not "Kwench"
            formattedText = formattedText.replace(/QNH/g, 'Q N H');

            return formattedText;
        }


        // --- REVISED SCRIPT TO FETCH AND SPEAK REPORTS ---
        async function fetchAllReports() {
            let fullReportText = 'Error loading report.';

            try {
                const response = await fetch('/atis');

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }

                const reports = await response.json();

                fullReportText = reports.fullReport || 'N/A';

                // ðŸŒŸ STEP 1: Format the text for speech synthesis ðŸŒŸ
                const spokenText = formatSpokenText(fullReportText);

                // 3. Display the reports and raw data
                document.getElementById('full-report').textContent = fullReportText;
                document.getElementById('datis-report').textContent = reports.datisReport || 'N/A';
                document.getElementById('raw-aemet').textContent = JSON.stringify(reports.rawAemet, null, 2) || 'N/A';
                document.getElementById('raw-lerm').textContent = JSON.stringify(reports.rawLerm, null, 2) || 'N/A';
                document.getElementById('raw-windy').textContent = JSON.stringify(reports.rawWindy, null, 2) || 'N/A';

                // ðŸŒŸ STEP 2: Synthesize the formatted text ðŸŒŸ
                speakText(spokenText, 'en-US', 0.9); // Use en-US for better pronunciation of aviation terms like QNH

            } catch (error) {
                const errorMessage = 'Error loading ATIS report: ' + error.message;
                document.getElementById('full-report').textContent = errorMessage;
                document.getElementById('datis-report').textContent = errorMessage;
                document.getElementById('raw-aemet').textContent = errorMessage;
                document.getElementById('raw-lerm').textContent = errorMessage;

                // Speak the error message
                speakText(errorMessage, 'en-US', 0.9);
            }
        }

        // Fetch and display the combined report
        fetchAllReports();
    </script>

</body>

</html>